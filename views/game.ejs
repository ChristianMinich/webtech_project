<html>
  <head>
    <link rel="stylesheet" href="./css/style.css" />
    <title>QuizGame</title>
    <style>
      .answers {
              border: 1px solid #000000;
              margin-bottom: 10px;
              text-align: center;
              cursor: default;
          }
    </style>
  </head>
  <body>
    <h1><%= roomID%></h1>
    <h2><%= username%></h2>
    <img src="<%= avatar%>" width="50px" height="50px">

    <div id="roundCounter"></div>

    <div class="scoreboard" id="scoreboard">
      <!-- scoreboard content will be dynamically generated -->
    </div>

    <div class="quizbox">

      <h2 id="question-text"></h2>
      <div class = "answers" id="option1-text"></div>
      <div class = "answers" id="option2-text"></div>
      <div class = "answers" id="option3-text"></div>
      <div class = "answers" id="option4-text"></div>
  </div>

  <div class = "user1" id="user_1"></div>
  <div class = "userscore1" id="userscore_1"></div>
  <div class = "user2" id="user_2"></div>
  <div class = "userscore2" id="userscore_2"></div>

  <div id="scoreboard-container">
    <table>
      <thead>
        <tr>
          <th>Rang</th>
          <th>Benutzername</th>
          <th>Punktzahl</th>
        </tr>
      </thead>
      <tbody id="scoreboard-body">
        <!-- Hier werden die Spieler eingefügt -->
      </tbody>
    </table>
  </div>
  
  <div id="end"></div>
  <div id="endButton">
    <form action="/index" method="GET">
      <button type="submit">Back to Dashboard</button>
    </form>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const roomId = "<%= roomID %>";
    const username = "<%= username %>";
    
    window.onload = function () {
      socket.emit('gamePageLoaded',roomId, username);
      console.log(username);
      document.getElementById("end").disabled = true;
      document.getElementById('user_1').disabled = true;
      document.getElementById('userscore_1').disabled = true;
      document.getElementById('user_2').disabled = true; 
      document.getElementById('userscore_2').disabled = true;
      document.getElementById("endButton").disabled = true;
    };

    const clickHandler = function() {
      socket.emit("questionSelected", roomId, username, this.textContent);
    };

      const option1TextElement = document.getElementById("option1-text");
      const option2TextElement = document.getElementById("option2-text");
      const option3TextElement = document.getElementById("option3-text");
      const option4TextElement = document.getElementById("option4-text");

      document.getElementById("option1-text").addEventListener("click", clickHandler);
      document.getElementById("option2-text").addEventListener("click", clickHandler);
      document.getElementById("option3-text").addEventListener("click", clickHandler);
      document.getElementById("option4-text").addEventListener("click", clickHandler);

    
      socket.on('question', function(question, round) {

      document.getElementById("roundCounter").textContent = round;

      console.log("Frage erhlaten");
      document.getElementById('question-text').textContent = question.text;
      document.getElementById('option1-text').textContent = question.answers[0];
      document.getElementById('option2-text').textContent = question.answers[1];
      document.getElementById('option3-text').textContent = question.answers[2];
      document.getElementById('option4-text').textContent = question.answers[3];
    });

    socket.on("test", (roomID) => {

      console.log("Test erfolgreich ! " + roomID);

    });

    socket.on("gameEnd", (players) => {
      option1TextElement.removeEventListener('click', clickHandler);
      option2TextElement.removeEventListener('click', clickHandler);
      option3TextElement.removeEventListener('click', clickHandler);
      option4TextElement.removeEventListener('click', clickHandler);

      document.getElementById('question-text').textContent = " ";
      document.getElementById('option1-text').textContent = " ";
      document.getElementById('option2-text').textContent = " ";
      document.getElementById('option3-text').textContent = " ";
      document.getElementById('option4-text').textContent = " ";

/*
      document.getElementById('user_1').disabled = false;
      document.getElementById('userscore_1').disabled = false;
      document.getElementById('user_2').disabled = false; 
      document.getElementById('userscore_2').disabled = false;

      document.getElementById('user_1').textContent = players[0].username;
      document.getElementById('userscore_1').textContent = players[0].score; 
      document.getElementById('user_2').textContent = players[1].username; 
      document.getElementById('userscore_2').textContent = players[1].score; 
*/
      document.getElementById("end").disabled = false;
      //document.getElementById("end").textContent = false;

      document.getElementById("endButton").disabled = false;

    //Scoreboard nach ende

      const answerElements = document.querySelectorAll('.answer');

  // Schleife über alle Antwort-Elemente
      answerElements.forEach((element) => {
      element.classList.remove('answer');
      });
      players.sort((a, b) => b.score - a.score);      
    const scoreboardContainer = document.getElementById("scoreboard-container");
    scoreboardContainer.innerHTML = ""; // Leeren des Inhalts des Behälters

    const scoreboardTable = document.createElement("table");
    const headerRow = document.createElement("tr");
    const rankHeader = document.createElement("th");
    rankHeader.textContent = "Rang";
    const usernameHeader = document.createElement("th");
    usernameHeader.textContent = "Benutzername";
    const scoreHeader = document.createElement("th");
    scoreHeader.textContent = "Punktzahl";

    headerRow.appendChild(rankHeader);
    headerRow.appendChild(usernameHeader);
    headerRow.appendChild(scoreHeader);
    scoreboardTable.appendChild(headerRow);

    players.forEach((player, index) => {
    const playerRow = document.createElement("tr");
    const rankCell = document.createElement("td");
    rankCell.textContent = index + 1;
    const usernameCell = document.createElement("td");
    usernameCell.textContent = player.username;
    const scoreCell = document.createElement("td");
    scoreCell.textContent = player.score;

    playerRow.appendChild(rankCell);
    playerRow.appendChild(usernameCell);
    playerRow.appendChild(scoreCell);
    scoreboardTable.appendChild(playerRow);
    });

      scoreboardContainer.appendChild(scoreboardTable);

    });

    socket.on("scoreBoard", function (players) {
          const scoreboardElement = document.getElementById("scoreboard");
          scoreboardElement.innerHTML = "";
          players.forEach(function (player) {
            const playerElement = document.createElement("div");
            playerElement.textContent = "Player: " + player.username + " | Score: " + player.score;
            scoreboardElement.appendChild(playerElement);
          });
        });
    
  
  </script>
    
  </body>
</html>
